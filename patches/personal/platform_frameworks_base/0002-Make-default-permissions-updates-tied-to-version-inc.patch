From 6365873fc9349ba348a2d9473766f46db4fadfc1 Mon Sep 17 00:00:00 2001
From: Luca Stefani <luca.stefani.ge1@gmail.com>
Date: Mon, 18 Nov 2024 21:24:57 +0100
Subject: [PATCH 2/8] Make default permissions updates tied to version
 incremental

Otherwise adding new rules won't have any effect for us.

Change-Id: Ib81082a184956ea550bdccdbdf53b2b4cc48f487
---
 .../com/android/server/pm/PackageManagerService.java   | 10 ++++++----
 .../pm/permission/PermissionManagerServiceImpl.java    |  3 ++-
 2 files changed, 8 insertions(+), 5 deletions(-)

diff --git a/services/core/java/com/android/server/pm/PackageManagerService.java b/services/core/java/com/android/server/pm/PackageManagerService.java
index 9e1843f3a91e..ab2bd06b2549 100644
--- a/services/core/java/com/android/server/pm/PackageManagerService.java
+++ b/services/core/java/com/android/server/pm/PackageManagerService.java
@@ -4303,7 +4303,7 @@ public class PackageManagerService implements PackageSender, TestUtilityService
             final int userId = livingUsers.get(i).id;
             final boolean isPermissionUpgradeNeeded = !Objects.equals(
                     mPermissionManager.getDefaultPermissionGrantFingerprint(userId),
-                    Build.FINGERPRINT);
+                    Build.VERSION.INCREMENTAL);
             if (isPermissionUpgradeNeeded) {
                 grantPermissionsUserIds = ArrayUtils.appendInt(
                         grantPermissionsUserIds, userId);
@@ -4312,7 +4312,8 @@ public class PackageManagerService implements PackageSender, TestUtilityService
         // If we upgraded grant all default permissions before kicking off.
         for (int userId : grantPermissionsUserIds) {
             mLegacyPermissionManager.grantDefaultPermissions(userId);
-            mPermissionManager.setDefaultPermissionGrantFingerprint(Build.FINGERPRINT, userId);
+            mPermissionManager.setDefaultPermissionGrantFingerprint(
+                    Build.VERSION.INCREMENTAL, userId);
         }
         if (grantPermissionsUserIds == EMPTY_INT_ARRAY) {
             // If we did not grant default permissions, we preload from this the
@@ -4476,7 +4477,8 @@ public class PackageManagerService implements PackageSender, TestUtilityService
         if (!convertedFromPreCreated || !readPermissionStateForUser(userId)) {
             mPermissionManager.onUserCreated(userId);
             mLegacyPermissionManager.grantDefaultPermissions(userId);
-            mPermissionManager.setDefaultPermissionGrantFingerprint(Build.FINGERPRINT, userId);
+            mPermissionManager.setDefaultPermissionGrantFingerprint(
+                    Build.VERSION.INCREMENTAL, userId);
             mDomainVerificationManager.clearUser(userId);
         }
     }
@@ -4488,7 +4490,7 @@ public class PackageManagerService implements PackageSender, TestUtilityService
             mPermissionManager.readLegacyPermissionStateTEMP();
             final boolean isPermissionUpgradeNeeded = !Objects.equals(
                     mPermissionManager.getDefaultPermissionGrantFingerprint(userId),
-                    Build.FINGERPRINT);
+                    Build.VERSION.INCREMENTAL);
             return isPermissionUpgradeNeeded;
         }
     }
diff --git a/services/core/java/com/android/server/pm/permission/PermissionManagerServiceImpl.java b/services/core/java/com/android/server/pm/permission/PermissionManagerServiceImpl.java
index 33d57d5cc2b9..49d33ebd761f 100644
--- a/services/core/java/com/android/server/pm/permission/PermissionManagerServiceImpl.java
+++ b/services/core/java/com/android/server/pm/permission/PermissionManagerServiceImpl.java
@@ -4651,7 +4651,8 @@ public class PermissionManagerServiceImpl implements PermissionManagerServiceInt
     @Nullable
     @Override
     public String getDefaultPermissionGrantFingerprint(@UserIdInt int userId) {
-        return mPackageManagerInt.isPermissionUpgradeNeeded(userId) ? null : Build.FINGERPRINT;
+        return mPackageManagerInt.isPermissionUpgradeNeeded(userId)
+                ? null : Build.VERSION.INCREMENTAL;
     }
 
     @Override
-- 
2.43.0

